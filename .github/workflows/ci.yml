# .github/workflows/ci.yml
name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  ci:
    name: Build and test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build --if-present

  diag_xai_v2_smoke_on_main:
    name: diag-xai-v2 smoke (push main only)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [ci]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Smoke call /api/diag/xai-v2
        env:
          DIAG_URL: ${{ secrets.TABARNAM_DIAG_XAI_V2_URL }}
          FUNCTION_KEY: ${{ secrets.TABARNAM_FUNCTION_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${DIAG_URL:-}" ]; then
            echo "Missing secret TABARNAM_DIAG_XAI_V2_URL"
            exit 1
          fi

          URL="$DIAG_URL"
          if [ -n "${FUNCTION_KEY:-}" ]; then
            if echo "$URL" | grep -q '\?'; then
              URL="${URL}&code=${FUNCTION_KEY}"
            else
              URL="${URL}?code=${FUNCTION_KEY}"
            fi
          fi

          echo "GET $URL"

          body="$(curl -sS -m 60 -H 'Accept: application/json' "$URL")"
          echo "$body"

          ok="$(echo "$body" | jq -r '.ok // empty')"
          smoke_ok="$(echo "$body" | jq -r '.smoke.ok // empty')"
          smoke_status="$(echo "$body" | jq -r '.smoke.status // empty')"

          if [ "$ok" != "true" ]; then
            echo "FAIL: .ok != true"
            exit 1
          fi

          if [ "$smoke_ok" != "true" ]; then
            echo "FAIL: .smoke.ok != true"
            exit 1
          fi

          if [ "$smoke_status" != "200" ]; then
            echo "FAIL: .smoke.status != 200 (got $smoke_status)"
            exit 1
          fi

          echo "PASS: diag/xai-v2 smoke ok"
