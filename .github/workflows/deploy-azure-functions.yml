name: Deploy Azure Functions

on:
  workflow_dispatch:

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build (Vite)
        run: npm run build

      - name: Write API build id file
        run: |
          printf '%s\n' "${GITHUB_SHA}" > api/__build_id.txt
          test -s api/__build_id.txt

      - name: Sanity check - fail fast if dist is missing
        run: |
          test -f dist/index.html || (echo "FATAL: dist/index.html missing" && exit 1)
          test -f dist/staticwebapp.config.json || (echo "FATAL: dist/staticwebapp.config.json missing" && exit 1)
          test -s api/__build_id.txt || (echo "FATAL: api/__build_id.txt missing or empty" && exit 1)

      - name: Install API dependencies
        run: cd api && npm install && cd ..

      - name: Deploy to Azure Functions
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN_V2 }}
          action: "upload"
          # Important: NEVER deploy from repo root (".") because CI installs node_modules,
          # which causes Azure Static Web Apps to reject the upload due to too many static files.
          # Deploy the built app folder (or the committed dist/) instead.
          app_location: "dist"
          api_location: "api"
          skip_app_build: true
