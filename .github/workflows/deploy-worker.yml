name: Deploy Worker (tabarnam-xai-dedicated)

# Deploys queue triggers and background workers to the dedicated Function App.
# The SWA-managed API (api/) is deployed via deploy-swa.yml to Static Web Apps.
# The dedicated worker (worker/) is deployed separately to tabarnam-xai-dedicated Function App.
#
# Required secrets:
# - WORKER_FUNCTIONAPP_PUBLISH_PROFILE: Full publish profile XML for tabarnam-xai-dedicated

on:
  push:
    branches: [ main ]
    paths:
      - 'worker/**'
      - '.github/workflows/deploy-worker.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Assert package root (worker/)
        run: |
          set -euo pipefail
          test -f worker/host.json
          test -d worker/functions
          test -d worker/functions/import-resume-worker
          echo "✓ worker/ package root looks correct"

      - name: Install worker dependencies
        run: |
          set -euo pipefail
          cd worker
          npm ci
          echo "✓ Worker dependencies installed"

      - name: Write deploy stamp file
        run: |
          set -euo pipefail
          node -e "const fs=require('node:fs'); const stamp={component:'worker',sha:process.env.GITHUB_SHA||'',run_id:process.env.GITHUB_RUN_ID||'',run_number:process.env.GITHUB_RUN_NUMBER||'',ts:new Date().toISOString()}; fs.writeFileSync('worker/__deploy_stamp.json', JSON.stringify(stamp)+'\n', 'utf8'); console.log('[deploy-stamp]', JSON.stringify(stamp));"

      - name: Deploy worker to tabarnam-xai-dedicated
        uses: Azure/functions-action@v1
        with:
          app-name: tabarnam-xai-dedicated
          package: worker
          publish-profile: ${{ secrets.WORKER_FUNCTIONAPP_PUBLISH_PROFILE }}

      - name: "Post-deploy: verify queue trigger registration"
        if: always()
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "✓ Worker deployed to tabarnam-xai-dedicated"
          echo ""
          echo "Expected behavior:"
          echo "  - import-resume-worker queue trigger listens to 'import-resume-worker' queue"
          echo "  - Connection setting: ENRICHMENT_QUEUE_CONNECTION_SETTING (default: AzureWebJobsStorage)"
          echo "  - Messages from SWA API are dequeued and processed by this worker"
          echo ""
          echo "Verify in Azure Portal:"
          echo "  1. Function App > Functions > import-resume-worker-queue-trigger"
          echo "  2. Monitor tab should show recent executions"
          echo "  3. Application Insights > Traces for any errors"

      - name: "Kudu (non-blocking): fetch app settings summary"
        if: always()
        continue-on-error: true
        env:
          WORKER_FUNCTIONAPP_PUBLISH_PROFILE: ${{ secrets.WORKER_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          set -euo pipefail
          node --input-type=module - <<'NODE'
          import { Buffer } from 'node:buffer';

          const profile = process.env.WORKER_FUNCTIONAPP_PUBLISH_PROFILE || '';

          const tagMatch =
            profile.match(/<publishProfile\b[^>]*publishMethod="ZipDeploy"[^>]*>/i) ||
            profile.match(/<publishProfile\b[^>]*publishMethod="MSDeploy"[^>]*>/i) ||
            profile.match(/<publishProfile\b[^>]*>/i);

          const tag = tagMatch ? tagMatch[0] : '';

          const getAttr = (name) => {
            const re = new RegExp(name + '="([^"]+)"', 'i');
            const m = tag.match(re);
            return m ? m[1] : '';
          };

          const user = getAttr('userName');
          const pass = getAttr('userPWD');
          const publishUrlRaw = getAttr('publishUrl');

          if (!user || !pass || !publishUrlRaw) {
            console.log('[kudu] Could not parse publish profile for Kudu credentials.');
            process.exit(0);
          }

          const publishHost = publishUrlRaw.replace(/^https?:\/\//i, '').replace(/:443$/i, '');
          const scmHost = publishHost.includes('.scm.')
            ? publishHost
            : publishHost.replace('.azurewebsites.net', '.scm.azurewebsites.net');

          const base = 'https://' + scmHost;
          const auth = Buffer.from(`${user}:${pass}`).toString('base64');

          const fetchAndPrint = async (path, desc) => {
            const url = base + path;
            let res;
            let text = '';

            try {
              res = await fetch(url, {
                headers: {
                  authorization: `Basic ${auth}`,
                  accept: 'application/json',
                },
              });
              text = await res.text();
            } catch (err) {
              console.log(`[kudu] ${desc} request failed:`, err?.message || String(err));
              return;
            }

            console.log(`[kudu] ${desc} -> HTTP ${res.status}`);
            if (res.ok) {
              try {
                const j = JSON.parse(text);
                const keys = Object.keys(j || {}).sort();
                console.log(`[kudu] Found ${keys.length} settings`);
              } catch {
                console.log(`[kudu] Response is not JSON`);
              }
            }
          };

          await fetchAndPrint('/api/settings', 'Settings');
          await fetchAndPrint('/api/vfs/site/wwwroot/', 'File list');
          NODE

      - name: Summary
        if: always()
        run: |
          echo "## Worker Deployment Summary"
          echo ""
          echo "**Status**: ${{ job.status }}"
          echo ""
          echo "### Next Steps"
          echo "1. Verify queue trigger is registered in Azure Portal"
          echo "2. Test by enqueueing a message to 'import-resume-worker' queue"
          echo "3. Check Application Insights for trigger executions"
          echo "4. Ensure SWA API endpoint /api/import/resume-worker still works (HTTP POST)"
