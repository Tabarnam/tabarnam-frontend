name: Deploy SWA (dist only)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: swa-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build (Vite)
        run: npm run build

      - name: Write API build id file
        run: |
          # SWA Functions runtime doesn't reliably expose commit env vars.
          # Persist the commit SHA in the API package so endpoints can report it.
          printf '%s\n' "${GITHUB_SHA}" > api/__build_id.txt
          test -s api/__build_id.txt

      - name: Sanity check - fail fast if wrong files deployed
        run: |
          echo "=== Critical pre-deployment checks ==="
          echo ""

          test -f dist/index.html || (echo "❌ FATAL: dist/index.html missing" && exit 1)
          echo "✓ dist/index.html exists"

          test -s api/__build_id.txt || (echo "❌ FATAL: api/__build_id.txt missing or empty" && exit 1)
          echo "✓ api/__build_id.txt exists (build id injected)"

          if grep -q "/src/main.jsx" dist/index.html; then
            echo "❌ FATAL: dist/index.html still references /src/main.jsx (dev version)"
            exit 1
          fi
          echo "✓ dist/index.html does NOT reference /src/main.jsx (built version confirmed)"

          grep -q "/assets/index-" dist/index.html || (echo "❌ FATAL: dist/index.html doesn't reference /assets/index-*.js" && exit 1)
          echo "✓ dist/index.html references /assets/index-*.js (built correctly)"

          test -f dist/staticwebapp.config.json || (echo "❌ FATAL: dist/staticwebapp.config.json missing" && exit 1)
          echo "✓ dist/staticwebapp.config.json exists"

          grep -q "application/javascript" dist/staticwebapp.config.json || (echo "⚠ Warning: mimeTypes.js not found in config" && exit 1)
          echo "✓ dist/staticwebapp.config.json has mimeTypes for .js"

          echo ""
          echo "=== dist/ folder contents ==="
          ls -lh dist/ | head -20

          echo ""
          echo "✅ All pre-deployment checks passed"

      - name: Deploy to Static Web Apps (dist only)
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN_V2 }}
          action: "upload"
          app_location: "dist"
          skip_app_build: true
          api_location: "api"

      - name: Seed test companies (disabled in CI)
        if: ${{ false }}
        env:
          COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }} # yamllint disable-line rule:truthy
          COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }} # yamllint disable-line rule:truthy
          COSMOS_DB_DATABASE: tabarnam-db
          COSMOS_DB_COMPANIES_CONTAINER: companies
        run: |
          if [ -z "$COSMOS_DB_ENDPOINT" ] || [ -z "$COSMOS_DB_KEY" ]; then
            echo "⚠️ Warning: Cosmos DB secrets not set, skipping seeding"
            exit 0
          fi
          node scripts/seed-test-companies.mjs
