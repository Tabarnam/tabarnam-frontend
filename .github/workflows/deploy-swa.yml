name: Deploy SWA (HTTP-only API)

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'src/**'
      - '.github/workflows/deploy-swa.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy SWA
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Verify no queue triggers in api/
        run: |
          # Fail if any queue trigger definitions are found in the API folder
          if grep -r "storageQueue\|queueTrigger" api/ --include="*.js" --include="*.json" | grep -v "node_modules" | grep -v ".funcignore"; then
            echo "❌ ERROR: Queue triggers found in api/ folder"
            echo "Queue triggers must NOT be in SWA-managed Functions."
            echo "Move them to the worker/ folder for external processing."
            exit 1
          fi
          echo "✅ Verified: No queue triggers in SWA API"

      - name: Install API dependencies
        run: npm ci --prefix api

      - name: Build API
        run: npm run build --prefix api 2>/dev/null || echo "No build script defined"

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: 'upload'
          app_location: '/'
          api_location: 'api'
          output_location: 'src'  # Adjust based on your frontend build output
          skip_app_build: false
          # Ensure SWA only builds API, not worker
          skip_api_build: false

      - name: Verify deployment
        run: |
          echo "✅ SWA deployment initiated"
          echo "API will be deployed as HTTP-only Functions (no queue triggers)"
          echo "Queue processing delegated to external worker at tabarnam-xai-dedicated"
