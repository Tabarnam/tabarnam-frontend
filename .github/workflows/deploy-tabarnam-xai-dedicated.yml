name: Deploy tabarnam-xai-dedicated

# Required secrets:
# - AZURE_FUNCTIONAPP_PUBLISH_PROFILE: Full publish profile XML (must include real userName and userPWD)
# - DEDICATED_FUNCTION_KEY: Function key used to call /api/diag (NOT the master key)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assert package root (api/)
        run: |
          set -euo pipefail
          test -f api/host.json
          test -d api/diag
          test -d api/import-start
          echo "api/ package root looks correct"

      - name: Write build id files
        run: node scripts/write-build-id.mjs

      - name: Write deploy stamp file (proof of what code was deployed)
        run: |
          set -euo pipefail
          node -e "const fs=require('node:fs'); const stamp={sha:process.env.GITHUB_SHA||'', run_id:process.env.GITHUB_RUN_ID||'', run_number:process.env.GITHUB_RUN_NUMBER||'', ts:new Date().toISOString()}; fs.writeFileSync('api/__deploy_stamp.json', JSON.stringify(stamp)+'\n', 'utf8'); console.log('[deploy-stamp]', JSON.stringify(stamp));"

      - name: Deploy tabarnam-xai-dedicated
        uses: Azure/functions-action@v1
        with:
          app-name: tabarnam-xai-dedicated
          package: api
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

      - name: Verify deployment via /api/diag (must fail if old handler is still running)
        env:
          DED_BASE: https://tabarnam-xai-dedicated-awe3h9bvcxckeja9.westus2-01.azurewebsites.net
          DEDICATED_FUNCTION_KEY: ${{ secrets.DEDICATED_FUNCTION_KEY }}
        run: |
          set -euo pipefail
          echo "[verify] GET $DED_BASE/api/diag"
          curl -fSsS "$DED_BASE/api/diag?code=$DEDICATED_FUNCTION_KEY" | tee diag.json
          node -e "const fs=require('node:fs'); const raw=fs.readFileSync('diag.json','utf8'); let j; try{ j=JSON.parse(raw);}catch(e){console.error('Invalid JSON from /api/diag'); process.exit(1);} const missing=[]; if(typeof j.handler_version!=='string' || !j.handler_version.trim()) missing.push('handler_version'); if(!j.handler_versions || typeof j.handler_versions!=='object') missing.push('handler_versions'); if(missing.length){ console.error('Missing required fields:', missing.join(', ')); console.error('Response:', raw.slice(0,2000)); process.exit(1);} console.log('[verify] ok handler_version='+j.handler_version);"

      - name: Kudu proof (list wwwroot and fetch deploy stamp)
        if: always()
        env:
          AZURE_FUNCTIONAPP_PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          set -euo pipefail
          node - <<'NODE'
          const profile = process.env.AZURE_FUNCTIONAPP_PUBLISH_PROFILE || '';

          const tagMatch =
            profile.match(/<publishProfile\b[^>]*publishMethod="ZipDeploy"[^>]*>/i) ||
            profile.match(/<publishProfile\b[^>]*publishMethod="MSDeploy"[^>]*>/i) ||
            profile.match(/<publishProfile\b[^>]*>/i);

          const tag = tagMatch ? tagMatch[0] : '';

          const getAttr = (name) => {
            const re = new RegExp(name + '="([^"]+)"', 'i');
            const m = tag.match(re);
            return m ? m[1] : '';
          };

          const user = getAttr('userName');
          const pass = getAttr('userPWD');
          const publishUrlRaw = getAttr('publishUrl');

          if (!user || !pass || !publishUrlRaw) {
            console.log('[kudu] Could not parse publish profile for Kudu credentials.');
            process.exit(0);
          }

          const publishHost = publishUrlRaw.replace(/^https?:\/\//i, '').replace(/:443$/i, '');
          const scmHost = publishHost.includes('.scm.') ? publishHost : publishHost.replace('.azurewebsites.net', '.scm.azurewebsites.net');
          const base = 'https://' + scmHost;

          console.log(JSON.stringify({ event: 'kudu_info', scmHost }));

          const { spawnSync } = require('node:child_process');
          const curl = (args) => spawnSync('curl', ['-sS', '-u', `${user}:${pass}`, ...args], { stdio: 'inherit' });
          curl([base + '/api/vfs/site/wwwroot/']);
          curl([base + '/api/vfs/site/wwwroot/__deploy_stamp.json']);
          NODE
