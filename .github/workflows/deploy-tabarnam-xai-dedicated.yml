# .github/workflows/deploy-tabarnam-xai-dedicated.yml
name: Deploy tabarnam-xai-dedicated

on:
  push:
    branches: [main]
    paths:
      - "api/**"
      - "scripts/**"
      - ".github/workflows/deploy-tabarnam-xai-dedicated.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-tabarnam-xai-dedicated
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assert package root (api/)
        shell: bash
        run: |
          set -euo pipefail
          test -f api/host.json
          test -d api/diag
          echo "api/ package root looks correct"

      - name: Write build id files
        run: node scripts/write-build-id.mjs

      - name: Write deploy stamp file
        shell: bash
        run: |
          set -euo pipefail
          node -e "const fs=require('node:fs'); const stamp={sha:process.env.GITHUB_SHA||'', run_id:process.env.GITHUB_RUN_ID||'', run_number:process.env.GITHUB_RUN_NUMBER||'', ts:new Date().toISOString()}; fs.writeFileSync('api/__deploy_stamp.json', JSON.stringify(stamp)+'\n', 'utf8'); console.log('[deploy-stamp]', JSON.stringify(stamp));"

      - name: Deploy tabarnam-xai-dedicated
        uses: Azure/functions-action@v1
        with:
          app-name: tabarnam-xai-dedicated
          package: api
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

      - name: Post deploy smoke (diag-xai-v2)
        env:
          DIAG_URL: ${{ secrets.TABARNAM_DIAG_XAI_V2_URL }}
          FUNCTION_KEY: ${{ secrets.TABARNAM_FUNCTION_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          test -n "$DIAG_URL"
          test -n "$FUNCTION_KEY"
          curl -fsS "$DIAG_URL?code=$FUNCTION_KEY" -o resp.json
          cat resp.json
          python - << 'PY'
          import json
          j=json.load(open("resp.json"))
          assert j.get("ok") is True
          assert j["smoke"]["ok"] is True
          assert j["smoke"]["status"] == 200
          print("PASS")
          PY
