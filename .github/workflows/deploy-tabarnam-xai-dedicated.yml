# .github/workflows/deploy-tabarnam-xai-dedicated.yml
name: Deploy tabarnam-xai-dedicated

on:
  push:
    branches: [main]
    paths:
      - "api/**"
      - "scripts/**"
      - ".github/workflows/deploy-tabarnam-xai-dedicated.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-tabarnam-xai-dedicated
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assert package root (api/)
        shell: bash
        run: |
          set -euo pipefail
          test -f api/host.json
          test -d api/diag
          echo "api/ package root looks correct"

      - name: Write build id files
        run: node scripts/write-build-id.mjs

      - name: Write deploy stamp file
        shell: bash
        run: |
          set -euo pipefail
          node -e "const fs=require('node:fs'); const stamp={sha:process.env.GITHUB_SHA||'', run_id:process.env.GITHUB_RUN_ID||'', run_number:process.env.GITHUB_RUN_NUMBER||'', ts:new Date().toISOString()}; fs.writeFileSync('api/__deploy_stamp.json', JSON.stringify(stamp)+'\n', 'utf8'); console.log('[deploy-stamp]', JSON.stringify(stamp));"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install API dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd api
          npm ci --omit=dev || npm install --omit=dev
          echo "node_modules installed:"
          ls -la node_modules | head -20

      # Azure Login using Service Principal (Flex Consumption doesn't support publish profiles)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy tabarnam-xai-dedicated
        uses: Azure/functions-action@v1
        with:
          app-name: tabarnam-xai-dedicated
          package: api
          # No publish-profile needed - uses Azure Login credentials

      - name: Validate dedicated diag endpoint
        shell: bash
        run: |
          set -euo pipefail

          URL="${TABARNAM_DIAG_XAI_V2_URL:-}"

          if [ -z "$URL" ]; then
            echo "ERROR: TABARNAM_DIAG_XAI_V2_URL is not set"
            exit 1
          fi

          case "$URL" in
            https://*.azurewebsites.net/api/diag*)
              echo "Using dedicated diag endpoint: $URL"
              ;;
            *)
              echo "ERROR: TABARNAM_DIAG_XAI_V2_URL does not point to the dedicated Functions host"
              echo "Value: $URL"
              exit 1
              ;;
          esac
        env:
          TABARNAM_DIAG_XAI_V2_URL: ${{ secrets.TABARNAM_DIAG_XAI_V2_URL }}

      - name: Smoke test xAI endpoint (dedicated only)
        shell: bash
        run: |
          set -euo pipefail

          url="${TABARNAM_DIAG_XAI_V2_URL}"
          if [ -n "${TABARNAM_FUNCTION_KEY:-}" ]; then
            if echo "$url" | grep -q '\?'; then
              url="${url}&code=${TABARNAM_FUNCTION_KEY}"
            else
              url="${url}?code=${TABARNAM_FUNCTION_KEY}"
            fi
          fi

          echo "GET $url"
          curl -fsS \
            --max-time 10 \
            --retry 2 \
            --retry-delay 1 \
            "$url" \
            -o resp.json

          cat resp.json

          python - << 'PY'
          import json
          j = json.load(open("resp.json"))
          assert j.get("ok") is True, f"Expected .ok=true, got {j.get('ok')}"
          assert j["smoke"]["ok"] is True, f"Expected .smoke.ok=true, got {j['smoke'].get('ok')}"
          assert j["smoke"]["status"] == 200, f"Expected .smoke.status=200, got {j['smoke'].get('status')}"
          print("PASS: diag/xai-v2 smoke ok")
          PY
        env:
          TABARNAM_DIAG_XAI_V2_URL: ${{ secrets.TABARNAM_DIAG_XAI_V2_URL }}
          TABARNAM_FUNCTION_KEY: ${{ secrets.TABARNAM_FUNCTION_KEY }}
